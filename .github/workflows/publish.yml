name: Publish filelock-lts-py37 to PyPI

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Select tag to publish'
        required: true
        type: choice
        options:
          - CVE-2025-68146

permissions:
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: pypi
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Checkout the specific tag
      run: |
        git checkout tags/${{ github.event.inputs.tag }}
        echo "=== Verifying we have the right code ==="
        cat pyproject.toml | head -20
        
    - name: Set up Python 3.7 using Docker
      run: |
        docker pull python:3.7-slim
        docker create --name py37builder -v $PWD:/workspace -w /workspace python:3.7-slim tail -f /dev/null
        docker start py37builder
        
    - name: Install dependencies in container
      run: |
        docker exec py37builder python -m pip install --upgrade pip build tomli
        
    - name: Verify package version matches Git Tag
      run: |
        PACKAGE_VERSION=$(docker exec py37builder python -c "import tomli; print(tomli.load(open('pyproject.toml', 'rb'))['project']['version'])")
        TAG_NAME="${{ github.event.inputs.tag }}"
        EXPECTED_VERSION=${TAG_NAME#CVE-}
        EXPECTED_VERSION=${EXPECTED_VERSION//-/.}
        
        echo "Package version: $PACKAGE_VERSION"
        echo "Expected version: $EXPECTED_VERSION"
        
        if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "::error::Version mismatch!"
          exit 1
        fi
        
    - name: Build package in container
      run: docker exec py37builder python -m build
      
    - name: Stop container
      run: docker stop py37builder && docker rm py37builder
      
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
