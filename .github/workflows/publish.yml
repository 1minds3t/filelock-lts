name: Publish filelock-lts-py37 to PyPI
on:
  release:
    types: [published]
  workflow_dispatch:
permissions:
  id-token: write
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: pypi
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-tags: true
        fetch-depth: 0
    
    - name: Checkout the tag
      run: |
        git fetch --tags
        TAG=$(git tag | head -1)
        echo "Checking out tag: $TAG"
        git checkout $TAG
      
    - name: Set up Docker build container for Python 3.7
      run: |
        docker pull python:3.7-slim
        docker run -d --name py37builder -v $PWD:/workspace -w /workspace python:3.7-slim tail -f /dev/null
        
    - name: Install dependencies in container
      run: docker exec py37builder python -m pip install --upgrade pip build
        
    - name: Verify package version matches Git Tag
      run: |
        PACKAGE_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
        TAG_NAME=$(git tag | head -1)
        EXPECTED_VERSION=${TAG_NAME#CVE-}
        EXPECTED_VERSION=${EXPECTED_VERSION//-/.}
        
        echo "Version in pyproject.toml: $PACKAGE_VERSION"
        echo "Version from Git Tag ('$TAG_NAME'): $EXPECTED_VERSION"
        
        if [ "$PACKAGE_VERSION" != "$EXPECTED_VERSION" ]; then
          echo "::error::Version mismatch! The version in pyproject.toml ($PACKAGE_VERSION) must match the version from the Git tag ($EXPECTED_VERSION)."
          exit 1
        fi
        
    - name: Build wheel only in container
      run: docker exec py37builder python -m build --wheel
      
    - name: Stop and remove container
      if: always()
      run: docker stop py37builder && docker rm py37builder
      
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
