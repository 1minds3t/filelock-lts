name: Publish filelock-lts to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to build'
        required: true
        type: choice
        options:
          - 'dispatcher'
          - '3.7'
          - '3.8'
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
          - '3.14'

permissions:
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: pypi
    
    steps:
    - name: Determine Python version and branch
      id: python_info
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          INPUT="${{ github.event.inputs.python_version }}"
          if [ "$INPUT" == "dispatcher" ]; then
            PY_VERSION="3.9"
            BRANCH="main"
            IS_DISPATCHER="true"
            echo "ðŸ“¦ Manual: Building dispatcher from main"
          else
            PY_VERSION="$INPUT"
            BRANCH="py${PY_VERSION}"
            IS_DISPATCHER="false"
            echo "ðŸ“¦ Manual: Building Python $PY_VERSION from $BRANCH"
          fi
        else
          TAG_NAME="${{ github.event.release.tag_name }}"
          echo "ðŸ·ï¸ Processing tag: $TAG_NAME"
          
          # Match: CVE-2025-68146 or CVE-2025-68146.1 (dispatcher)
          if [[ "$TAG_NAME" =~ ^CVE-[0-9]+-[0-9]+(\.[0-9]+)?$ ]]; then
            PY_VERSION="3.9"
            BRANCH="main"
            IS_DISPATCHER="true"
            echo "ðŸ“¦ Dispatcher release from main"
          # Match: CVE-2025-68146-py37, CVE-2025-68146.1-py38
          elif [[ "$TAG_NAME" =~ -py([0-9])([0-9]+)$ ]]; then
            PY_VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
            BRANCH="py${PY_VERSION}"
            IS_DISPATCHER="false"
            echo "ðŸ“¦ Python $PY_VERSION release from $BRANCH"
          # Match: CVE-2025-68146-py310, CVE-2025-68146-py314
          elif [[ "$TAG_NAME" =~ -py([0-9]+)$ ]]; then
            PY_NUM="${BASH_REMATCH[1]}"
            PY_VERSION="${PY_NUM:0:1}.${PY_NUM:1}"
            BRANCH="py${PY_VERSION}"
            IS_DISPATCHER="false"
            echo "ðŸ“¦ Python $PY_VERSION release from $BRANCH"
          else
            echo "::error::Cannot parse tag: $TAG_NAME"
            echo "::error::Expected: CVE-2025-68146 (dispatcher) or CVE-2025-68146-py37 (specific)"
            exit 1
          fi
        fi
        
        echo "version=$PY_VERSION" >> $GITHUB_OUTPUT
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "is_dispatcher=$IS_DISPATCHER" >> $GITHUB_OUTPUT
    
    - name: Checkout correct branch
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.python_info.outputs.branch }}
        fetch-depth: 0
    
    - name: Set up Python build environment
      run: |
        PY_VERSION="${{ steps.python_info.outputs.version }}"
        docker pull python:${PY_VERSION}-slim
        docker run -d --name pybuilder \
          -v $PWD:/workspace \
          -w /workspace \
          python:${PY_VERSION}-slim \
          tail -f /dev/null
    
    - name: Install build tools
      run: docker exec pybuilder python -m pip install --upgrade pip build
    
    - name: Verify package metadata
      run: |
        PACKAGE_NAME=$(grep '^name = ' pyproject.toml | cut -d'"' -f2)
        PACKAGE_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
        IS_DISPATCHER="${{ steps.python_info.outputs.is_dispatcher }}"
        PY_VERSION="${{ steps.python_info.outputs.version }}"
        
        echo "ðŸ“¦ Package: $PACKAGE_NAME"
        echo "ðŸ·ï¸ Version: $PACKAGE_VERSION"
        
        if [ "$IS_DISPATCHER" == "true" ]; then
          if [ "$PACKAGE_NAME" != "filelock-lts" ]; then
            echo "::error::Expected 'filelock-lts', got '$PACKAGE_NAME'"
            exit 1
          fi
          echo "âœ… Dispatcher package verified"
        else
          EXPECTED_SUFFIX="py${PY_VERSION//.}"
          if [[ ! "$PACKAGE_NAME" =~ $EXPECTED_SUFFIX ]]; then
            echo "::error::Package '$PACKAGE_NAME' missing suffix '$EXPECTED_SUFFIX'"
            exit 1
          fi
          echo "âœ… Python $PY_VERSION package verified"
        fi
    
    - name: Build package
      run: docker exec pybuilder python -m build --sdist --wheel
    
    
    - name: Show build artifacts
      run: ls -lh dist/
    
    - name: Cleanup Docker
      if: always()
      continue-on-error: true
      run: docker stop pybuilder && docker rm pybuilder
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true
    
    - name: Build summary
      run: |
        IS_DISPATCHER="${{ steps.python_info.outputs.is_dispatcher }}"
        PACKAGE_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
        
        echo "### ðŸŽ‰ Published to PyPI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$IS_DISPATCHER" == "true" ]; then
          echo "**Package:** filelock-lts (dispatcher)" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $PACKAGE_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** Auto-selects correct version for Python 3.7-3.14" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Package:** filelock-lts-py${{ steps.python_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $PACKAGE_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Python:** ${{ steps.python_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        fi
