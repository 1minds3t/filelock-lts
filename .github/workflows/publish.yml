name: Publish filelock-lts to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to build (3.7, 3.8, 3.9)'
        required: true

permissions:
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: pypi
    
    steps:
    - name: Determine Python version and branch
      id: python_info
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          PY_VERSION="${{ github.event.inputs.python_version }}"
          BRANCH="py${PY_VERSION}"
        else
          # Extract from release target (branch name)
          BRANCH="${{ github.event.release.target_commitish }}"
          
          # Extract Python version from branch name (py3.7 -> 3.7)
          if [[ "$BRANCH" =~ py([0-9]+\.[0-9]+) ]]; then
            PY_VERSION="${BASH_REMATCH[1]}"
          elif [[ "$BRANCH" =~ ([0-9]+\.[0-9]+) ]]; then
            PY_VERSION="${BASH_REMATCH[1]}"
          else
            echo "::error::Could not determine Python version from branch: $BRANCH"
            exit 1
          fi
        fi
        
        echo "version=$PY_VERSION" >> $GITHUB_OUTPUT
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Building Python $PY_VERSION from branch $BRANCH"
    
    - name: Checkout the branch
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.python_info.outputs.branch }}
        fetch-depth: 0
      
    - name: Set up Docker build container
      run: |
        PY_VERSION="${{ steps.python_info.outputs.version }}"
        docker pull python:${PY_VERSION}-slim
        docker run -d --name pybuilder \
          -v $PWD:/workspace \
          -w /workspace \
          python:${PY_VERSION}-slim \
          tail -f /dev/null
        
    - name: Install build dependencies
      run: docker exec pybuilder python -m pip install --upgrade pip build
        
    - name: Verify package metadata
      run: |
        PACKAGE_NAME=$(grep '^name = ' pyproject.toml | cut -d'"' -f2)
        PACKAGE_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
        
        echo "ðŸ“¦ Package: $PACKAGE_NAME"
        echo "ðŸ·ï¸  Version: $PACKAGE_VERSION"
        
        # Verify it's the correct package for this Python version
        PY_VERSION="${{ steps.python_info.outputs.version }}"
        EXPECTED_SUFFIX="py${PY_VERSION//.}"
        
        if [[ ! "$PACKAGE_NAME" =~ $EXPECTED_SUFFIX ]]; then
          echo "::warning::Package name ($PACKAGE_NAME) doesn't contain expected suffix ($EXPECTED_SUFFIX)"
        fi
        
    - name: Build distributions
      run: docker exec pybuilder python -m build
      
    - name: List built packages
      run: ls -lh dist/
      
    - name: Stop and remove container
      if: always()
      run: docker stop pybuilder && docker rm pybuilder
      
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true

    - name: Summary
      run: |
        echo "### ðŸŽ‰ Published to PyPI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: filelock-lts-py${{ steps.python_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: $(grep '^version = ' pyproject.toml | cut -d'"' -f2)" >> $GITHUB_STEP_SUMMARY
        echo "- **Python**: ${{ steps.python_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
